# Convex Pipeline Persistence Design

## Goals
- Persist automation pipeline definitions (metadata, steps, scheduling, webhook secrets, run history) in Convex so signed-in users can access them across devices.
- Mirror the existing `PipelineRepository` API surface without breaking JSON/in-memory fallbacks.
- Provide secure HTTP actions guarded by Convex admin tokens for the Next.js app.

**Status:** Schema + functions implemented in `web/convex/schema.ts`, `web/convex/pipelines.ts`, and exposed via `web/convex/http.ts`. This document remains the reference for future enhancements (account scoping, hashed secrets, run history table).

## Data Model

### `pipelines` Table
| Field | Type | Notes |
| ----- | ---- | ----- |
| `id` | `string` | UUID generated by server. Indexed. |
| `name` | `string` | Trimmed pipeline name. |
| `description` | `optional string` | Markdown-ish description. |
| `steps` | `array` | Serialized steps matching `PipelineStep` union. |
| `schedule` | `optional object` | Cron-like metadata. |
| `defaultSource` | `optional string` | Default import source configuration. |
| `webhookSecret` | `string` | UUID v4 (plaintext for now; see security notes). |
| `createdAt` | `string` ISO8601 | Creation timestamp. |
| `updatedAt` | `string` ISO8601 | Last modification. |
| `lastRunAt` | `optional string` | Last completed run. |

Indexes:
- `by_id` (`id`)
- `by_name` (`name`)
- `by_webhook_secret` (`webhookSecret`)

### `pipeline_runs` Table (optional phase 2)
| Field | Type | Notes |
| ----- | ---- | ----- |
| `pipelineId` | `string` | reference to pipeline |
| `runId` | `string` | UUID |
| `status` | `string` | queued / running / success / failed |
| `startedAt` / `completedAt` | ISO strings |
| `error` | optional string/any |

## Convex Functions

### Queries
- `pipelines/list` – args `{}` -> pipelines sorted by name.
- `pipelines/get` – args `{ id: string }` -> single pipeline or null.
- `pipelines/findByWebhookSecret` – args `{ secret: string }` -> pipeline (plaintext secret check).

### Mutations
- `pipelines/create` – args `{ input: PipelineCreateInput }`
- `pipelines/update` – args `{ id: string, input: PipelineUpdateInput }`
- `pipelines/delete` – args `{ id: string }`
- `pipelines/recordRun` – args `{ id: string, completedAt: string }`

### Security Considerations
- Current implementation stores webhook secrets in plaintext to maintain compatibility with existing UI flows. Follow-up: introduce hashed storage + reveal-on-create UX.
- Guard HTTP actions via `CONVEX_DEPLOYMENT_KEY`/`CONVEX_ADMIN_KEY`.
- Future enhancement: add per-account scoping once multi-user sharing requirements solidify.

## HTTP Action Mapping
| HTTP Path | Convex Function |
| --------- | ---------------- |
| `/pipelines/list` | `pipelines/list` |
| `/pipelines/get` | `pipelines/get` |
| `/pipelines/findByWebhookSecret` | `pipelines/findByWebhookSecret` |
| `/pipelines/create` | `pipelines/create` |
| `/pipelines/update` | `pipelines/update` |
| `/pipelines/delete` | `pipelines/delete` |
| `/pipelines/recordRun` | `pipelines/recordRun` |

All actions require admin token; client includes `Authorization: <scheme> <token>`.

## Work Breakdown
1. Define schema additions in `web/convex/schema.ts` + generated bindings.
2. Implement query/mutation functions in `web/convex/pipelines.ts`.
3. Wire HTTP actions inside `web/convex/http.ts` (reuse admin guard).
4. Update `ConvexPipelineRepository` endpoints to match naming (already aligned).
5. Add unit tests (Convex function behaviours + repository fallback) and update integration tests.

## Open Questions
- Should `accountId` map to Clerk ID or Convex `accounts` table entry? (Recommendation: reuse `account.userId` string.)
- Do we need per-pipeline role sharing? (Out of scope for first pass.)
- How to rotate webhook secrets? (Current repository regenerates secret on update with `rotateSecret`; ensure mutation mirrors this.)
